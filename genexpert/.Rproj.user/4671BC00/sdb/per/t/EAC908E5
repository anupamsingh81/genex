{
    "collab_server" : "",
    "contents" : "library(dplyr)\nlibrary(ggplot2)\n\nmaster = master.chart %>% select(-c(ADA,SUGAR,PROTEIN,TLC.DLC))\n\nsummary(master$AFB.CULTURE)\n\nsummary(master$AFB.SMEAR)\n\nsummary(master$MTB.DETED)\n\n\nmaster1 = master %>% filter(!(AFB.CULTURE==\"NOT SENT\"|AFB.CULTURE==\"NA\"|AFB.CULTURE==\"IN PROCESS\"|AFB.CULTURE==\"INPROGRESS\"|\n                    AFB.SMEAR==\"\"|AFB.SMEAR==\"NOT SENT\"|AFB.SMEAR==\"NA\"))\n                  \n                  \nsummary(master1$MTB.DETED)\n\nsummary(master1$AFB.SMEAR)\n\nsummary(master1$AFB.CULTURE)\n\nmaster2 = master1 %>% filter(!(MTB.DETED==\"INPROGRESS\"|MTB.DETED==\"IN PROCESS\"|MTB.DETED==\"EXPIRED\"|\n                                 MTB.DETED==\"REJECTED\"))\n\nsummary(master2$MTB.DETED==\"D\"|master2$MTB.DETED==\" D\")\n\nlibrary(stringr)\n\n\nsummary(str_detect(master2$MTB.DETED,\"D\"))\n\nmaster2$xpert = ifelse(str_detect(master2$MTB.DETED,\"D\"),\"Positive\",\"Negative\")\n\nsummary(as.factor(master2$xpert))\n\nsummary(master2$AFB.SMEAR)\n\nmaster2$smear = ifelse(master2$AFB.SMEAR==\"Y\"|master2$AFB.SMEAR==\"P\",\"Positive\",\"Negative\")\n\nsummary(as.factor(master2$smear))\n\n\nsummary(str_detect(master2$AFB.CULTURE,\"NG AT\"))\n\nmaster2=master2 %>% filter(!(str_detect(AFB.CULTURE,\"NA\")))\n\nlibrary(stringr)\n\nmaster2$culture = ifelse(str_detect(master2$AFB.CULTURE,\"NG AT\")|str_detect(master2$AFB.CULTURE,\"NG AFTER\"),\"Negative\",\"Positive\")\n\nmaster2$time = str_extract(master2$AFB.CULTURE,\"[0-9]\") # Extract numeric\n\nsummary(master2$L.M.H)\n\nsummary(as.factor(master2$xpert))\n\nmaster2$ct = ifelse(str_detect(master2$L.M.H,\"VL\"),\"VL\",\n                 ifelse(str_detect(master2$L.M.H,\"L\"),\"L\",\n                                        \n              ifelse(str_detect(master2$L.M.H,\"M\"),\"M\",\n              ifelse(str_detect(master2$L.M.H,\"H\"),\"H\",\n                                         \"\"))))\n\nmaster2$ct = ifelse(!(master2$ct==\"H\"|master2$ct==\"M\"|master2$ct==\"L\"|master2$ct==\"VL\"),NA,master2$ct) # Avoid \"NA\" in string\n\nsummary(as.factor(master2$ct))\n\nfit= aov(master2$time~master2$ct)\nplot(fit)\nTukeyHSD(fit)\n\nlibrary(ggplot2)\n\nmaster2$time = as.numeric(master2$time)\n\nmaster2  %>%filter(!is.na(ct)) %>%   ggplot(aes(x= reorder(ct,time,FUN=median),y=time,fill=ct))+geom_boxplot()+ coord_flip()+\nlabs( title = \" Time to positivity decreases with higher Ct\",\n        x = \"Ct\",\n        y= \"Time to positivity\")\n# I marked + at start of labs and was stuck, be careful\n\nmaster2 %>% group_by(culture,smear,ct) %>% summarize(n=n(),mean=mean(time),sd=sd(time))\n\nmaster2 %>% group_by(culture,ct) %>% summarize(n=n())\n\nmaster2 %>% group_by(culture,smear,xpert) %>% summarize(n=n())\n\n\n\n\n\n\nmaster2 %>% ggplot(aes(ct,is.numeric(time)))+stat_summary(fun.y=mean,fun.ymin=min,fun.ymax=max)\n\nsummary(as.factor(master2$SPECIMENTYPE)))\n\nsummary(str_detect(master2$SPECIMENTYPE,\"BAL\"))\n\nsummary(str_detect(master2$SPECIMENTYPE,\"PL\"))\n\nsummary(str_detect(master2$SPECIMENTYPE,\"SPUTUM\"))\n\n\n\nmaster2$specimen = ifelse(str_detect(master2$SPECIMENTYPE,\"BAL\")|str_detect(master2$SPECIMENTYPE,\"LUNG\")|str_detect(master2$SPECIMENTYPE,\"Bronchial\"),\"BAL\",\n                          ifelse(str_detect(master2$SPECIMENTYPE,\"PL\"),\"Pleural\",\n                                ifelse(str_detect(master2$SPECIMENTYPE,\"SPUTUM\"),\"Sputum\",\"Others\" )))\n\nsummary(as.factor(master2$specimen))\n\nk = master2 %>% group_by(specimen,culture,smear,xpert) %>% summarize(n=n()) %>% arrange(desc(n)) \nprint.data.frame(k)\n\nl=master2 %>% group_by(specimen,culture,ct) %>% summarize(n=n()) %>% arrange(desc(n))\nprint.data.frame(l)\n\nm=master2 %>% group_by(specimen,culture,smear,ct) %>% summarize(n=n(),mean=mean(time),sd=sd(time))\n\nprint.data.frame(m)\n\ntable(master2$xpert,master2$culture)\ntable(master2$smear,master2$culture)\n\n\n78/128\n\nwrite.csv(master2,\"doc.csv\")\n\n\nmaster2 %>% group_by(specimen) %>% filter(xpert==\"Positive\",culture==\"Negative\") %>% summarize(\n  n=n())\n\nk2 = as.data.frame(master2 %>% count(specimen))\nk2$n\n\nmaster2 %>% group_by(specimen) %>% filter(xpert==\"Negative\",culture==\"Positive\") %>% summarize(\n  n=n()) %>% mutate(Total = k2$n,proportion = n/k2$n) %>% \n  ggplot(mapping= aes(x=reorder(specimen,proportion),proportion,fill=specimen)) + geom_bar(stat=\"identity\")+coord_flip()+ labs(\n    title = \"Discordant(Xpert negative,culture positive cases)\",\n    x= \"specimen\",\n    y= \"Proportion\")\n\n\n  \n\nmaster2 %>% group_by(specimen) %>% filter(xpert==\"Positive\",culture==\"Negative\") %>% summarize(\n  n=n()) %>% mutate(Total = k2$n,proportion = n/k2$n) %>% ggplot(mapping= aes(x=reorder(specimen,proportion),proportion,fill=specimen)) + geom_bar(stat=\"identity\")+coord_flip()+ labs(\n    title = \"Discordant(Xpert Positive,culture negative cases)\",\n    x= \"specimen\",\n    y= \"Proportion\")\n\nmaster2 %>% filter(xpert==\"Negative\",culture==\"Positive\") %>% summarize(n=n(),mean_TTP= mean(time), sd(time))\n\nmaster2$ctd = ifelse(master2$xpert==\"Negative\" & master2$culture==\"Positive\",\"Discordant\",master2$ct)\n\nsummary(as.factor(master2$ctd))\n\n\nfit1= aov(master2$time~master2$ctd)\nsummary(fit1)\nTukeyHSD(fit1)\n\n\nmaster2  %>%filter(!is.na(ctd)) %>%   ggplot(aes(x= reorder(ctd,time,FUN=median),y=time,fill=ctd))+geom_boxplot()+ coord_flip()+\n  labs( title = \" Time to positivity decreases with higher Ct\",\n        x = \"Ct\",\n        y= \"Time to positivity\")\n\n\nwrite.csv(master2,\"good_doc.csv\")\n\n# ROC CURVE\n#https://cran.r-project.org/web/packages/plotROC/vignettes/examples.html\n# \nlibrary(tidyverse)\nlibrary(plotROC)\n\nmaster_roc = master2 %>% select(smear,xpert,culture,specimen)\n\ntable(master_roc$xpert,master_roc$culture)\ntable(master_roc$smear,master_roc$culture)\n\ntest = master_roc %>% mutate( microscopy = ifelse(smear==\"Negative\",0,1), gene_xpert = ifelse(xpert==\"Negative\",0,1), afb_culture = ifelse(culture==\"Negative\",0,1)) %>% \n  select(microscopy,gene_xpert,afb_culture,specimen)\n\ntable(test$gene_xpert,test$afb_culture)\n  \nhead(test)\nlongtest4 <- melt_roc(test4, \"afb_culture\", c(\"microscopy\", \"gene_xpert\"))\nhead(longtest2)\n\n\nroc1 =ggplot(longtest1, aes(d = D, m = M, color = name)) + geom_roc() + style_roc()\nroc2 =ggplot(longtest2, aes(d = D, m = M, color = name)) + geom_roc() + style_roc()\nroc3 = ggplot(longtest3, aes(d = D, m = M, color = name)) + geom_roc() + style_roc()\nroc4 = ggplot(longtest4, aes(d = D, m = M, color = name)) + geom_roc() + style_roc()\n\nlibrary(gridExtra)\n\ngrid.arrange(roc1,roc2,roc3,roc4)\nlibrary(pROC)\nsmear_roc = roc(test4$afb_culture,test4$microscopy ,data=test4)\n\nxpert_roc = roc(test4$afb_culture,test4$gene_xpert ,data=test4)\n\nxpert_roc$specificities[2]\nxpert_roc$sensitivities[2]\nsmear_roc$specificities[2]\nsmear_roc$sensitivities[2]\n\ntable(test4$gene_xpert,test4$afb_culture)\n\ntest1 = test %>% filter(specimen==\"BAL\")\ntest2 = test %>% filter(specimen==\"Sputum\")\ntest3 = test %>% filter(specimen==\"Pleural\")\n\ntest4= test %>% filter(specimen==\"Others\")\n\nroc.test(smear_roc,xpert_roc)\n\n\nplot(smear_roc,col=\"red\")\nplot(xpert_roc,add=TRUE,col=\"blue\")\n\nlegend('bottomright', names(dat)[c(3:4)] , \n       lty=1, col=c('red', 'blue'),  cex=.75)\n\n\ntitle(main =\" Comparison Of Area under Curves of gene-xpert and smear microscopy\",line = 3.0)\n\n\ntable(dat$smear,dat$culture)\n\ntable(dat$xpert,dat$culture)\n\n\ntable(dat$smear,dat$xpert,dat$culture)\n\n\n\n# Net Benefit analysis overall\n\nlibrary(rmda)\n\ndat$culture = ifelse(dat$culture==\"negative\",0,1)\n\n\nsmear.model <- decision_curve(culture1~smear, \n                              \n                              data = master2,\n                              study.design = \"cohort\",\n                              policy = \"opt-in\", #default\n                              bootstraps = 50)\n\n\nadd_gene_xpert.model <- decision_curve(culture1~smear+xpert, \n                                       \n                                       data = master2,\n                                       study.design = \"cohort\",\n                                       policy = \"opt-in\", #default\n                                       bootstraps = 50)\n\nxpert.model <- decision_curve(culture1~xpert, \n                              \n                              data = master2,\n                              study.design = \"cohort\",\n                              policy = \"opt-in\", #default\n                              bootstraps = 50)\n\n\n\nplot_decision_curve( list(smear.model, add_gene_xpert.model),\n                     curve.names = c(\"smear microscopy\", \"smear and gene xpert\"), xlim =\n                       c(0, 1), legend.position = \"bottomright\")\n\nplot_decision_curve( list(smear.model, xpert.model),\n                     curve.names = c(\"smear microscopy\", \"gene xpert\"), xlim =\n                       c(0, 1), legend.position = \"bottomright\")\n\n\nmaster2 %>% filter(culture==\"Negative\",ct==\"L\") %>%  summarize(n=n())\n\nmaster2$culture1 = ifelse(master2$culture==\"Negative\",0,1)\n\nlibrary(survival)\n\n\n\n\nsave.image()\n\nsurvdiff(Surv(time,culture1)~ct,data=master2)\n\nlibrary(ggfortify)\n\n# http://rpubs.com/sinhrks/plot_surv\nsurv <- survfit(Surv(time, culture1) ~ ct, data = master2)\nsurv1 = autoplot(surv,conf.int = FALSE,ylab= \"Proportion of Cultures with No growth\", xlab= \"Time to Positivity in Weeks\")\nsurv1\n?autoplot\n",
    "created" : 1506257168189.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2964815865",
    "id" : "EAC908E5",
    "lastKnownWriteTime" : 1506269211,
    "last_content_update" : 1506269211809,
    "path" : "~/Downloads/gene_xpert/genexpert/genex.R",
    "project_path" : "genex.R",
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}